================================================================================
競馬予測システム - 問題解決と現状報告
================================================================================
作成日時: 2025-11-11

【1. 発見された問題】
================================================================================

■ 問題1: オッズデータの不正使用（重大）
  - 症状: バックテストで99.9%の的中率（不自然）
  - 原因: CSVの'Odds'列が確定オッズ（レース後）を含んでいた
  - 証拠: オッズ順予測で100%的中（循環論理）
  - 影響: 予測が実質的に結果を見てから予測していた

■ 問題2: race_idからの日付推定の誤り（重大）
  - 症状: バックテストと実際の使用結果の大幅な乖離
  - 原因: race_idフォーマットの誤解
    - 間違った理解: 202506010101 = 2025年6月1日
    - 正しい理解: 202506010101 = 2025年 中山競馬場(06) 1回 1日目 1R
  - 影響:
    1. 期間抽出が間違っていた（競馬場コードを月と誤認）
    2. 日付抽出が間違っていた（未来データを含んでしまった）
  - 結果: データリーケージが発生し、虚偽の高精度を示していた

【2. 実施した修正】
================================================================================

■ 修正1: オッズデータの除外
  - validate_no_odds.py を作成
  - 過去成績のみで予測スコアを計算
  - 使用データ: 直近3走の着順、距離適性、成績安定性

■ 修正2: 正しい日付フィルタリング
  - validate_correct_backtest.py を作成
  - race_idではなくdate列を使用
  - 正しい期間抽出: df['date_parsed'] >= '2025-06-01' & <= '2025-08-31'
  - 正しい過去データ取得: past_races[past_races['date_parsed'] < race_date_parsed]

【3. 修正後の正しいバックテスト結果】
================================================================================

対象期間: 2025年6月1日～2025年8月31日
対象レース数: 891レース

■ 3頭BOX（◎○▲）:
  【馬連】
    的中率: 27.9%
    回収率: 158.3%
    損益: +155,760円

  【3連複】
    的中率: 14.1%
    回収率: 707.3%
    損益: +541,140円

■ 5頭BOX（◎○▲△☆）:
  【馬連】
    的中率: 48.5%
    回収率: 90.6%
    損益: -84,090円

  【3連複】
    的中率: 32.0%
    回収率: 135.0%
    損益: +311,720円

【4. 現状の評価】
================================================================================

■ 良い点:
  - バックテストが正しく動作するようになった
  - 的中率が現実的な範囲（14-48%）
  - データリーケージが解消された

■ 課題:
  - 3頭BOX 3連複の的中率14.1%は低い
  - ユーザーの実際の使用結果（0-20%）と比較すると
    まだギャップがある可能性
  - オッズ情報を完全に除外したため、市場の知恵を
    活用できていない

【5. ベンチマーク比較】
================================================================================

予測手法               | 馬連的中率 | 備考
--------------------- | --------- | ------------------
ランダム予測（3頭）     |   4.0%    | 理論値
人気順（1-3番人気）     |  32.0%    | 単純ベースライン
オッズ順（1-3位）       | 100.0%    | 確定オッズ使用（無効）
AI予測（過去成績のみ）  |  27.9%    | 現在のシステム

【6. 次のステップ（推奨）】
================================================================================

優先度1: オッズ情報の適切な活用
  - 事前予想オッズを取得する方法を検討
  - AIスコアと市場オッズの乖離度を計算
  - 乖離が大きい馬を重視する戦略

優先度2: 予測精度の向上
  - 騎手情報の追加
  - 調教情報の追加
  - 馬場状態と相性の詳細分析
  - 枠順の影響分析

優先度3: 検証ツールの整備
  - HTML形式のレポート生成
  - レースごとの詳細結果表示
  - 的中/不的中のパターン分析

【7. 技術的な詳細】
================================================================================

■ race_idフォーマット（12桁）:
  YYYYPPKKDDRR
  - YYYY: 開催年（4桁）
  - PP: 競馬場コード（2桁）
    01=札幌, 02=函館, 03=福島, 04=新潟, 05=東京, 06=中山
    07=中京, 08=京都, 09=阪神, 10=小倉
  - KK: 開催回次（2桁）
  - DD: 開催日目（2桁）
  - RR: レース番号（2桁）

  例: 202506010101
    → 2025年 中山競馬場 1回開催 1日目 1レース
    → 実際の開催日は別途date列で管理

■ 予測スコア計算式（現在）:
  ベーススコア: 50点

  + 直近3走の平均着順
    - 平均2位以内: +30点
    - 平均3位以内: +20点
    - 平均5位以内: +10点
    - 平均8位以内: +5点
    - それ以上: -10点

  + 成績安定性（標準偏差）
    - σ≤1: +10点
    - σ≤2: +5点
    - σ≥5: -5点

  + 距離適性
    - 類似距離（±200m）での好走: +15点/回（3着以内）
    - 類似距離での5着以内: +5点/回

【8. 作成したファイル一覧】
================================================================================

1. debug_date_mismatch.py
   - race_idと実際の日付の整合性チェック
   - 不一致率86.7%を発見

2. analyze_race_id_format.py
   - race_idの正しいフォーマットを解析
   - 日付推定不可能と判明

3. validate_correct_backtest.py
   - 修正版バックテスト（正しい日付使用）
   - 現在の標準検証ツール

4. show_detailed_predictions.py
   - レースごとの予測と結果を表示
   - 的中/不的中を明示

5. check_odds_order_prediction.py
   - オッズ順予測の的中率検証
   - 100%的中を確認（証拠）

【9. まとめ】
================================================================================

■ 現状:
  - データリーケージ問題を完全に解決
  - 正しいバックテストが動作
  - 的中率は現実的な範囲
  - オッズ情報は現在未使用

■ 結論:
  システムは基本的に正しく動作しているが、予測精度は
  まだ改善の余地がある。特に、ユーザーの当初の意図
  であった「市場オッズとの乖離を利用する」戦略を
  実装することで、精度向上が期待できる。

================================================================================
