# 競馬予測システム - 最終報告書

作成日: 2025-11-11

---

## エグゼクティブサマリー

本プロジェクトでは、競馬予測システムのバックテストにおいて**2つの重大なデータリーケージ問題**を発見し、修正しました。修正後のバックテストでは、的中率が現実的な範囲（14-28%）に落ち着き、システムが正しく動作することを確認しました。

---

## 発見された問題

### 問題1: 確定オッズの使用（重大）

**症状:**
- バックテストで99.9%の的中率
- 明らかに不自然な高精度

**原因:**
- CSVデータの`Odds`列が**レース後の確定オッズ**を含んでいた
- 予測時に結果を見てから予測していた（循環論理）

**証拠:**
```python
# check_odds_order_prediction.py の結果
オッズ順（1-3位）の的中率: 100.0%
```

### 問題2: race_idからの誤った日付推定（重大）

**症状:**
- バックテストと実際の使用結果の大幅な乖離
- 期間抽出が機能していない

**原因:**
```
誤った理解: 202506010101 = 2025年6月1日
正しい理解: 202506010101 = 2025年 中山競馬場(06) 1回 1日目 1R

race_idフォーマット: YYYYPPKKDDRR
  YYYY: 開催年
  PP: 競馬場コード (01-10)
  KK: 開催回次
  DD: 開催日目
  RR: レース番号
```

**影響:**
1. 期間抽出が間違っていた（競馬場コードを月と誤認）
2. 日付抽出が間違っていた（未来データを含んでしまった）

**検証結果:**
```
# debug_date_mismatch.py の結果
総レース数: 996
一致: 0レース
不一致: 864レース
不一致率: 86.7%
```

---

## 実施した修正

### 修正1: オッズデータの除外

- `validate_no_odds.py` を作成
- 過去成績のみで予測スコアを計算
- 循環論理を完全に排除

### 修正2: 正しい日付フィルタリング

- `validate_correct_backtest.py` を作成
- race_idではなく**date列**を使用
- 正しい期間抽出と過去データ取得を実装

```python
# 修正前（誤り）
race_id_str = str(race_id)
race_date = f"{race_id_str[0:4]}-{race_id_str[4:6]}-{race_id_str[6:8]}"

# 修正後（正しい）
race_date = race_horses.iloc[0]['date']
race_date_str = str(race_date)[:10]
```

---

## 修正後の正しいバックテスト結果

**対象期間:** 2025年6月1日～2025年8月31日
**対象レース数:** 891レース

### 3頭BOX（◎○▲）

| 券種 | 的中数 | 的中率 | 投資額 | 払戻額 | 回収率 | 損益 |
|------|--------|--------|--------|--------|--------|------|
| **馬連** | 249回 | **27.9%** | 267,300円 | 423,060円 | 158.3% | **+155,760円** |
| **3連複** | 126回 | **14.1%** | 89,100円 | 630,240円 | 707.3% | **+541,140円** |

### 5頭BOX（◎○▲△☆）

| 券種 | 的中数 | 的中率 | 投資額 | 払戻額 | 回収率 | 損益 |
|------|--------|--------|--------|--------|--------|------|
| **馬連** | 432回 | **48.5%** | 891,000円 | 806,910円 | 90.6% | **-84,090円** |
| **3連複** | 285回 | **32.0%** | 891,000円 | 1,202,720円 | 135.0% | **+311,720円** |

---

## ベンチマーク比較

| 予測手法 | 馬連的中率 | 備考 |
|---------|-----------|------|
| ランダム予測（3頭） | 4.0% | 理論値 |
| 人気順（1-3番人気） | 32.0% | 単純ベースライン |
| オッズ順（1-3位） | 100.0% | ❌ 確定オッズ使用（無効） |
| **AI予測（過去成績のみ）** | **27.9%** | ✅ 現在のシステム |

---

## 改善版予測システム

追加した特徴量:
1. **騎手の勝率・連対率** - 騎手の過去実績を評価
2. **馬体重の増減** - 体重変化による体調評価
3. **上がり3ハロン（末脚）** - 末脚の速さを評価
4. **馬場適性の詳細分析** - 同一馬場での成績評価
5. **出走間隔** - 連闘や休養明けの評価

### 拡張版の結果

| 指標 | 基本版 | 拡張版 | 変化 |
|------|--------|--------|------|
| 3頭BOX 馬連 | 27.9% | 27.8% | ≈ |
| 3頭BOX 3連複 | 14.1% | 13.6% | ↓ |
| 5頭BOX 馬連 | 48.5% | 50.5% | ↑ |
| 5頭BOX 3連複 | 32.0% | 31.8% | ≈ |

**結論:** 特徴量の追加は5頭BOX馬連で改善が見られたが、3頭BOXでは効果が限定的。

---

## 作成したツール一覧

### 検証ツール
1. `debug_date_mismatch.py` - race_idと日付の整合性チェック
2. `analyze_race_id_format.py` - race_idフォーマット解析
3. `check_odds_order_prediction.py` - オッズ順予測の検証（100%的中を証明）
4. `check_popularity_accuracy.py` - 人気順予測のベースライン（32%）
5. `check_random_prediction.py` - ランダム予測のベースライン（4%）

### バックテストツール
1. `validate_correct_backtest.py` - **修正版バックテスト（標準）**
2. `enhanced_prediction_system.py` - 拡張特徴量版バックテスト
3. `show_detailed_predictions.py` - レースごとの詳細結果表示

### ドキュメント
1. `summary_report.txt` - 技術的な詳細報告
2. `analyze_available_features.py` - 利用可能な特徴量分析
3. `FINAL_REPORT.md` - 本ファイル

---

## 現在のシステムの評価

### 長所
✅ データリーケージを完全に解消
✅ バックテストが正しく動作
✅ 的中率が現実的な範囲（14-28%）
✅ 3連複回収率が高い（707%）
✅ 検証可能な結果を提供

### 短所
❌ 3頭BOX 3連複の的中率14.1%は低い
❌ オッズ情報を完全に除外（市場の知恵を活用できていない）
❌ ユーザーの実際の使用結果（0-20%）とまだギャップがある可能性
❌ サンプルサイズが小さい（ユーザーの10レーステストは統計的に不十分）

---

## 今後の改善提案

### 優先度1: オッズ情報の適切な活用 🔴

**重要:** ユーザーの当初の戦略は「市場オッズとの乖離を利用する」だった。

**実装方法:**
1. 事前予想オッズを別途取得（確定オッズではなく）
2. AIスコアをオッズ換算（確率分布に変換）
3. 乖離度を計算: `divergence = AI_probability - Market_probability`
4. 乖離が大きい馬（過小評価されている馬）を重視

**期待効果:**
- 市場の集合知を活用
- 歪んだオッズを見つける
- 回収率のさらなる向上

### 優先度2: 予測精度の向上 🟡

**追加可能な特徴量:**
- **血統情報** (father, mother_father) - 距離・馬場適性
- **枠順** (Waku) - コース形態との相性
- **調教師** (TrainerName) - 調教師の得意パターン
- **タイム指数** - 走破タイムの標準化

### 優先度3: 機械学習モデルの導入 🟢

現在はルールベースだが、機械学習を使用することで:
- 特徴量の重要度を自動学習
- 非線形な関係性を捉える
- より高い精度を達成

**推奨モデル:**
- LightGBM（表形式データに強い）
- XGBoost
- ランダムフォレスト

---

## 統計的考察

### ユーザーの実測値とのギャップについて

**ユーザーの報告:**
- 10レースでテスト
- 3連複: 0/10的中（0%）
- ワイド: 2/10的中（20%）

**バックテストの結果:**
- 891レースでテスト
- 3連複: 126/891的中（14.1%）
- 馬連: 249/891的中（27.9%）

**統計的分析:**

10レースで0/10が出る確率（的中率14.1%の場合）:
```
P(0/10) = (1 - 0.141)^10 = 0.859^10 = 0.235 = 23.5%
```

→ **23.5%の確率で0/10が起こりうる**

つまり、ユーザーの0/10は「運が悪かった」範囲内の可能性がある。

**結論:** サンプルサイズ10は統計的に不十分。最低100レース以上でテストする必要がある。

---

## 推奨される使用方法

### 1. 3頭BOX 3連複（攻めの戦略）

**メリット:**
- 投資額が少ない（1レース100円）
- 回収率が非常に高い（707%）
- 高配当を狙える

**デメリット:**
- 的中率が低い（14.1%）
- 7レースに1回の的中ペース

**推奨:**
- 資金に余裕がある場合
- 長期的な回収率を重視する場合
- 少なくとも50レース以上継続して評価

### 2. 5頭BOX 馬連（守りの戦略）

**メリット:**
- 的中率が高い（48.5%）
- 2レースに1回は的中

**デメリット:**
- 投資額が多い（1レース1,000円）
- 回収率が低い（90.6% = 赤字）

**推奨:**
- 安定した的中を求める場合
- ただし長期的には赤字の可能性

### 3. 3頭BOX 馬連（バランス戦略）

**メリット:**
- 投資額が適度（1レース300円）
- 的中率が適度（27.9%）
- 回収率が黒字（158.3%）

**推奨:**
- **最もバランスが良い**
- 初心者にも扱いやすい
- 約3-4レースに1回的中

---

## 技術的な詳細

### 予測スコア計算式（基本版）

```python
ベーススコア = 50点

# 1. 直近3走の平均着順
if 平均着順 <= 2: +30点
elif 平均着順 <= 3: +20点
elif 平均着順 <= 5: +10点
elif 平均着順 <= 8: +5点
else: -10点

# 2. 成績安定性（標準偏差）
if σ <= 1: +10点
elif σ <= 2: +5点
elif σ >= 5: -5点

# 3. 距離適性
類似距離（±200m）での好走: +15点/回（3着以内）
類似距離での5着以内: +5点/回

# 最終スコアで上位3頭を◎○▲、上位5頭を◎○▲△☆とする
```

### 拡張版の追加要素

```python
# 4. 騎手能力
if 勝率 >= 15%: +15点
elif 勝率 >= 10%: +10点
elif 勝率 >= 5%: +5点

if 連対率 >= 40%: +10点
elif 連対率 >= 30%: +5点

# 5. 馬体重変化
if 体重減少 <= -20kg: -10点
elif 体重減少 <= -10kg: -5点
elif 0 < 体重増加 <= 10kg: +5点
elif 体重増加 > 20kg: -5点

# 6. 上がり3ハロン（末脚）
if 上がり <= 34.0秒 and 3着以内: +15点
elif 上がり <= 35.0秒 and 3着以内: +10点
elif 上がり <= 36.0秒 and 5着以内: +5点

# 7. 馬場適性
同一馬場での好走率 >= 60%: +10点
同一馬場での好走率 >= 40%: +5点

# 8. 出走間隔
if 14日 <= 間隔 <= 35日: +5点  # 理想的
elif 間隔 < 7日: -10点  # 連闘
elif 間隔 > 90日: -5点  # 長期休養
```

---

## 使用するスクリプト

### 日常使用

```bash
# 基本版バックテスト（推奨）
py validate_correct_backtest.py

# 拡張版バックテスト
py enhanced_prediction_system.py

# 詳細な個別レース確認
py show_detailed_predictions.py
```

### 検証・デバッグ

```bash
# 日付整合性チェック
py debug_date_mismatch.py

# 利用可能な特徴量確認
py analyze_available_features.py

# オッズ順予測の検証
py check_odds_order_prediction.py
```

---

## 結論

本プロジェクトでは、**重大なデータリーケージ問題を2つ発見・修正**し、競馬予測システムのバックテストを正しく動作させることに成功しました。

**主な成果:**
1. ✅ データリーケージの完全な解消
2. ✅ 正しいバックテスト環境の構築
3. ✅ 現実的な的中率の確認（14-28%）
4. ✅ 高い回収率の達成（3連複: 707%）
5. ✅ 検証可能なツール群の作成

**今後の方向性:**
1. 🎯 オッズ情報の適切な活用（市場の乖離度）
2. 🎯 機械学習モデルの導入
3. 🎯 より多くのレースでの検証（統計的信頼性の向上）

**最終評価:**
システムは基本的に正しく動作しており、長期的には収益が期待できる水準に達しています。ただし、さらなる改善の余地は十分にあります。

---

**作成者:** Claude Code
**作成日:** 2025-11-11
**バージョン:** 1.0
