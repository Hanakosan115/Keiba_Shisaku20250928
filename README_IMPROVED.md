# 競馬分析ツール - 改善版

## 改善内容

### 1. 予測ロジックの根本的な改善

#### 従来の問題点
- 特徴量が50個以上あり、過学習のリスクが高い
- オッズ（市場の評価）を軽視し、AIが独自予測に走る
- 結果として人気薄を過剰に推奨し、的中率が低い

#### 改善後のアプローチ
```
【新しい予測の考え方】
オッズ = 群衆の知恵（最も優れた予測の出発点）
AI = オッズの「歪み」を検出する役割

最終評価 = オッズ基準値 + AI補正
```

### 2. 特徴量の大幅削減（50個以上 → 約15個）

#### コア特徴量（必須・10個）
1. **オッズ・人気** ← 最重要
2. **直近3走の着順**
3. **騎手の実績**
4. **枠番**
5. **距離適性**
6. **馬場適性**
7. **斤量**
8. **前走からの間隔**
9. **馬体重変動**
10. **上がり3F**

#### 補助特徴量（5個）
11. **血統統計**（父のみ、シンプル化）
12. **前走との条件変化スコア** ← 穴馬発見のカギ！
13. **騎手乗り替わり効果**
14. **距離適性スコア**
15. **馬場適性スコア**

#### 削除した特徴量（過学習の原因）
- ❌ 複雑なタイム指数計算
- ❌ 地方競馬転入フラグ
- ❌ レースレベル計算
- ❌ ハナ主張度スコア
- ❌ 母父の統計
- ❌ 脚質の複雑な計算

### 3. オッズ乖離度分析

```python
乖離度 = AI予測確率 - オッズ期待勝率

判定:
+10%以上: 強い過小評価（大穴候補）
+5~10%: 過小評価（穴候補）
±5%以内: 妥当（オッズ通り）
-5~-10%: やや過大評価
-10%以下: 強い過大評価（危険）
```

### 4. 印と自信度の自動付与

#### 印の付け方
- **◎（本命）**: AI総合評価1位
- **○（対抗）**: AI総合評価2位
- **▲（単穴）**: 評価3位 or 人気薄で高評価
- **△（連下）**: 評価4位 or 穴馬候補

#### 自信度の判定基準
- **S級（90%以上）**: 鉄板
  - オッズ1-2番人気 + AI評価1位 + 直近成績安定

- **A級（70-89%）**: 信頼度高
  - オッズとAI評価が一致
  - または人気薄だがAI高評価（掘り出し物）

- **B級（50-69%）**: 中程度
  - どちらか一方で高評価

- **C級（50%未満）**: 低い
  - 人気だけ、不安定要素多数

### 5. 前走との条件比較（穴馬発見機能）

AIが以下のパターンを検出：

#### パターン1: 距離変更
```
前走: 2400m 10着
今回: 1800m
→ スコア +1.5 「距離が合わなかっただけかも」
```

#### パターン2: 馬場状態の変化
```
前走: 重馬場 12着
今回: 良馬場
→ スコア +1.0 「得意な馬場に戻る」
```

#### パターン3: コース替わり
```
前走: ダート惨敗
今回: 芝（過去に芝で好走歴あり）
→ スコア +1.5 「本来のコースに戻る」
```

#### パターン4: 枠順改善
```
前走: 外枠不利
今回: 内枠有利
→ スコア +0.5
```

### 6. 過大評価馬の警告

人気だがAI評価が低い馬を警告：
```
例: 3番人気だが...
- 血統人気だけで実力不足
- 前走の好走が偶然（展開利）
- 距離・馬場が合わない
→ 「注意」として表示
```

## 使い方

### 起動方法

```bash
python run_improved_analyzer.py
```

### 予測の手順

1. **「予測」タブ**を開く
2. **レースID**を入力（例: 202406010101）
   - netkeiba.comのレースページURLから取得
   - 例: `https://race.netkeiba.com/race/shutuba.html?race_id=202406010101`
3. **「レース情報表示」**ボタンをクリック
4. 予測結果が表示されます

### 予測結果の見方

| 印 | 馬番 | 馬名 | オッズ | 人気 | AI予測(%) | オッズ予測(%) | 乖離度 | 自信度 |
|----|------|------|--------|------|-----------|---------------|--------|--------|
| ◎ | 5 | スターホース | 3.2 | 2 | 28.5 | 31.3 | -2.8 | A |
| ▲ | 12 | ダークホース | 15.0 | 8 | 12.0 | 6.7 | +5.3 | A |
| - | 3 | 人気馬 | 4.5 | 3 | 10.2 | 22.2 | -12.0 | C |

#### 読み方
- **5番（◎）**: オッズ通りの評価。自信度A
- **12番（▲）**: 人気薄だがAI高評価！乖離度+5.3の穴馬候補
- **3番**: 人気だがAI評価低い。過大評価の可能性（注意）

### 推奨買い目の例

```
【AI競馬予想 - 改善版】
==================================================

◎ 本命: 5番 スターホース
   オッズ: 3.2倍 (2番人気)
   AI予測: 28.5%
   自信度: A
   → 堅実な本命、信頼度高い

○ 対抗: 7番 チャンピオン
   オッズ: 5.1倍 (4番人気)
   AI予測: 18.2%
   自信度: B

▲ 単穴: 12番 ダークホース
   オッズ: 15.0倍 (8番人気)
   AI予測: 12.0%
   → オッズ以上の力あり！狙い目

△ 連下: 9番 サブマリン

--------------------------------------------------

【注意】人気だが危険な馬:
  3番 人気馬 (3番人気)
    → AI評価が低い。過大評価の可能性

【推奨買い目】
◇ 馬連: 5-7
◇ ワイド: 5-12
◇ 馬単: 5→7
```

## ファイル構成

```
Keiba_Shisaku20250928/
├── horse_racing_analyzer.py      # 既存のメインアプリ（元のまま）
├── improved_analyzer.py           # 改善版の分析エンジン
├── prediction_integration.py     # 統合モジュール
├── run_improved_analyzer.py      # 起動スクリプト（これを実行）
├── README_IMPROVED.md            # このファイル
├── settings.json                 # 設定ファイル
└── data/                         # データディレクトリ
    ├── horse_cache.pkl
    └── trained_lgbm_model_place.pkl
```

## 今後の改善予定

### Phase 1（完了）
- ✅ 特徴量の削減と整理
- ✅ オッズ乖離度分析の実装
- ✅ 印と自信度の自動付与

### Phase 2（次のステップ）
- ⏳ バックテスト機能の実装
  - 過去データでの的中率検証
  - 自信度別の的中率分析
  - パラメータ調整

- ⏳ 新しい特徴量でのモデル再訓練
  - 簡潔な特徴量セットで学習
  - オッズを重視した学習

### Phase 3
- ⏳ UIのさらなる改善
  - グラフ表示の追加
  - リアルタイムオッズ更新

- ⏳ パフォーマンス最適化
  - キャッシング強化
  - 並列処理の導入

## 注意事項

1. **この予想はAIによる分析結果です**
   - 馬券購入は自己責任でお願いします
   - 必ず余裕資金で楽しんでください

2. **データ収集について**
   - netkeiba.comのrobots.txtと利用規約を遵守してください
   - 適切な待機時間を設定してください

3. **モデルの限界**
   - 競馬は本質的にランダム性が高いゲームです
   - どんなに優れたAIでも100%の的中は不可能です
   - 1番人気の的中率でも約30-35%程度です

## よくある質問

### Q: オッズがまだ出ていない（新馬戦など）場合は？
A: 予想オッズが必要です。出馬表の「予想オッズ」を使用してください。

### Q: 乖離度がプラスなのに自信度Cなのはなぜ？
A: 直近成績が不安定など、他の要素で減点されている可能性があります。

### Q: 的中率はどのくらい？
A: バックテスト機能を実装予定です。現在検証中。

## サポート

問題が発生した場合:
1. エラーメッセージを確認
2. settings.jsonの設定を確認
3. データファイルの存在を確認

---
**Good Luck!**
